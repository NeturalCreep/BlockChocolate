<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <canvas width="600px" height="300px" style="border: 1px solid black;"></canvas>
    <script src="BlockChocolate.js"></script>
    <script>
        var Name = prompt("输入昵称:");
        var Tool = new THE_BEST_TOOL_CLASS('http://192.168.47.254');
        var DemoPng = Tool.getImg('ImgBg/Demo.png');// 需要联网获取
        var Floor = Tool.getImg('ImgBg/auto11.png');// 需要联网获取
        var Flower = Tool.getImg('ImgBg/flower14bq.png');// 需要联网获取
        var animeTitle =new TITLEIMAGE(DemoPng,73,106,4,"Anime");
        var classAnime = new BCAnime(animeTitle,false);
      
    var BC = new BlockChocolateEngine(document.getElementsByTagName('canvas')[0],20,10);
    BC.addEventListener(function(event){
        console.log(event);
    });
    
    var MainCamera = new Camera(BC);
    var SpriteLayer = new Layer(false,BC);
    var InteractiveLayer = new Layer(false,BC);
    var Player = new Sprite(BC,[6,0],Name);
    Player.Animes =classAnime;
    var TitleMap = new TitleMap();
    Tool.ReadXMLGetLayers('Room1.tmx',TitleMap);
    

    SpriteLayer.addSprite(Player);
    MainCamera.setMainSprite(Player);
    TitleMap.AddNewLayer(SpriteLayer);
    BC.SetTitleMapMange(TitleMap);
    BC.setMainCamera(MainCamera);
    window.addEventListener('load',function(){
    BC.Start();
    var curanime = 0;
    window.onkeydown = function(data){
        if(curanime!=data.keyCode){
            curanime = data.keyCode;
         MainCamera.getMainSprite().StopAnimePlay();
        }
        switch(data.keyCode){
            case 65:
            MainCamera.getMainSprite().Move2Target([-1,0],2);
            ws.send('{"ACTION":"MOVE","NAME":"'+Name+'","X":"'+-1+'","Y":"'+0+'"}');
                break;
            case 87:
            MainCamera.getMainSprite().Move2Target([0,-1],1);
            console.log("CALL VOID: ",[0,-1],1);
            ws.send('{"ACTION":"MOVE","NAME":"'+Name+'","X":"'+0+'","Y":"'+-1+'"}');
                break;
             case 68:
             MainCamera.getMainSprite().Move2Target([1,0],3);
            ws.send('{"ACTION":"MOVE","NAME":"'+Name+'","X":"'+1+'","Y":"'+0+'"}');
                break;
            case 83:
            console.log("CALL VOID: ",[0,1],0);
                 MainCamera.getMainSprite().Move2Target([0,1],0);
            ws.send('{"ACTION":"MOVE","NAME":"'+Name+'","X":"'+0+'","Y":"'+1+'"}');
                 break;
        }
    }
    window.onkeyup = function(){
         MainCamera.getMainSprite().StopAnimePlay();
    }
    
     ws = new WebSocket('ws:localhost:8080');
     
        ws.onopen = function(){
            console.log("连接成功!");
            var json = '{"ACTION":"JOIN","NAME":"'+Name+'"}';
            ws.send(json);
        }
        ws.onmessage = function(data){
            var DATA = JSON.parse(data.data);
            if(DATA.ACTION=='JOINED'){
                if(DATA.NAME!=Name){
                    
                var newPlayer = new Sprite(BC,[0,1],DATA.NAME);
                newPlayer.Animes =classAnime;
                 SpriteLayer.addSprite(newPlayer);
                 console.log("添加新玩家["+DATA.NAME+"]");
                }
            }
            else if(DATA.ACTION=="ONLINEPLAYER"){
                var newPlayer = new Sprite(BC,[parseInt(DATA.X),parseInt(DATA.Y)],DATA.NAME);
                newPlayer.Animes =classAnime;
                 SpriteLayer.addSprite(newPlayer);
                 console.log("添加在线玩家["+DATA.NAME+"]");
            }
            else if(DATA.ACTION=="MOVED"){
                SpriteLayer.getSprites().forEach(element => {
                    if(element.Name==DATA.NAME){
                        element.Move2Target([parseInt(DATA.X),parseInt(DATA.Y)],Player.Animes[3]);
                        element.StopAnimePlay();
                    }
                });
            }
            else if(DATA.ACTION=="EXIT"){
                SpriteLayer.getSprites().forEach(element => {
                    if(element.Name==DATA.NAME){
                console.log('EXIT',DATA);
                        SpriteLayer.DelSprite(element);
                    }
                });
            }
        }
    })
    var ws;
    </script>
</body>
</html>